
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Tego language">
      
      
      
        <meta name="author" content="Daniel A. A. Pelsmaeker">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.0.6">
    
    
      
        <title>Coroutines - Tego</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.2c0c5eaf.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.7fa14f5b.min.css">
        
          
          
          <meta name="theme-color" content="#546d78">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=:300,400,400i,700%7CJetBrains+Mono&display=fallback">
        <style>:root{--md-text-font-family:"";--md-code-font-family:"JetBrains Mono"}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="orange">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#coroutines" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Tego" class="md-header__button md-logo" aria-label="Tego" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M368 32h-56a16 16 0 0 0-16 16v48h-48V48a16 16 0 0 0-16-16h-80a16 16 0 0 0-16 16v48H88.1V48a16 16 0 0 0-16-16H16A16 16 0 0 0 0 48v176l64 32c0 48.33-1.54 95-13.21 160h282.42C321.54 351 320 303.72 320 256l64-32V48a16 16 0 0 0-16-16zM224 320h-64v-64a32 32 0 0 1 64 0zm144 128H16a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h352a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Tego
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Coroutines
            
          </span>
        </div>
      </div>
    </div>
    <div class="md-header__options">
      
    </div>
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/Virtlink/tego-lang/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href=".." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../start/" class="md-tabs__link">
        Getting Started
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../tutorial/" class="md-tabs__link">
        Tutorials
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../howto/" class="md-tabs__link">
        How-Tos
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../reference/" class="md-tabs__link">
        Reference
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../background/index.md" class="md-tabs__link">
        Background
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../develop/" class="md-tabs__link">
        Develop
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Tego" class="md-nav__button md-logo" aria-label="Tego" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M368 32h-56a16 16 0 0 0-16 16v48h-48V48a16 16 0 0 0-16-16h-80a16 16 0 0 0-16 16v48H88.1V48a16 16 0 0 0-16-16H16A16 16 0 0 0 0 48v176l64 32c0 48.33-1.54 95-13.21 160h282.42C321.54 351 320 303.72 320 256l64-32V48a16 16 0 0 0-16-16zM224 320h-64v-64a32 32 0 0 1 64 0zm144 128H16a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h352a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16z"/></svg>

    </a>
    Tego
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/Virtlink/tego-lang/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        Getting Started
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Getting Started" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../start/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../start/releases/" class="md-nav__link">
        Releases
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        Tutorials
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Tutorials" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Tutorials
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../tutorial/" class="md-nav__link">
        Tutorials
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../tutorial/tutorial1/" class="md-nav__link">
        Tutorial 1
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        How-Tos
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="How-Tos" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          How-Tos
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../howto/" class="md-nav__link">
        How-Tos
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      <label class="md-nav__link" for="__nav_5">
        Reference
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../reference/" class="md-nav__link">
        Reference
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../reference/modules/" class="md-nav__link">
        Modules
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../reference/strategies/" class="md-nav__link">
        Strategies
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../reference/java-interop/" class="md-nav__link">
        Java Interop
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      <label class="md-nav__link" for="__nav_6">
        Background
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Background" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Background
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../background/index.md" class="md-nav__link">
        None
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      <label class="md-nav__link" for="__nav_7">
        Develop
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Develop" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Develop
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../develop/" class="md-nav__link">
        Developing Tego
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../develop/documentation/" class="md-nav__link">
        Documentation
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cps" class="md-nav__link">
    CPS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#state-machine" class="md-nav__link">
    State Machine
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#single-function" class="md-nav__link">
    Single Function
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#non-suspending-computations" class="md-nav__link">
    Non-suspending Computations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handling-exceptions" class="md-nav__link">
    Handling Exceptions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#see-also" class="md-nav__link">
    See Also
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/Virtlink/tego-lang/edit/master/docs/coroutines.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="coroutines">Coroutines<a class="headerlink" href="#coroutines" title="Permanent link">&para;</a></h1>
<p>Continuations that are used to implement cooperative scheduling are called <em>coroutines</em>.</p>
<p>The trick to performing lazy (and possibly asynchronous) computation in Java is to explicitly encode the control flow. Instead of letting a function simply run to its end and return, we rewrite the method to use continuation passing style and provide it with a continuation that handles the result. This way, we can pause execution any time we want, and call the continuation as soon as we want to continue (as the name implies).</p>
<p>Imagine a function <code>updatePerson</code>, which loads a person's record using its ID, updates its name, and saves the record again. The function returns the timestamp of when the record was saved. </p>
<div class="highlight"><pre><span></span><code><span class="kt">long</span> <span class="nf">updatePerson</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Updating person with ID: &quot;</span> <span class="o">+</span> <span class="n">id</span><span class="p">);</span>
    <span class="n">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="n">personRepository</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
    <span class="n">person</span><span class="p">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">personRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">person</span><span class="p">);</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Updated at: &quot;</span> <span class="o">+</span> <span class="n">timestamp</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">timestamp</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>We would call this function like this:</p>
<div class="highlight"><pre><span></span><code><span class="kt">long</span> <span class="n">result</span> <span class="o">=</span> <span class="n">updatePerson</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s">&quot;Aya&quot;</span><span class="p">);</span>
</code></pre></div>
<p>Now we want to rewrite <code>updatePerson</code> as a coroutine, i.e. a computation that can be suspended. We do this using continuation-passing style (CPS). We explicitly provide a continuation that the function should call to continue execution. The continuation represents the rest of the computation to be performed once this computation is done. So we change the signature to accept the continuation as the last parameter. Also, the function should no longer return its result though <code>return</code>, but instead by calling the continuation.</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span> <span class="nf">updatePerson</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">Consumer</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">onCompletion</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Updating person with ID: &quot;</span> <span class="o">+</span> <span class="n">id</span><span class="p">);</span>
    <span class="n">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="n">personRepository</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
    <span class="n">person</span><span class="p">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">personRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">person</span><span class="p">);</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Updated at: &quot;</span> <span class="o">+</span> <span class="n">timestamp</span><span class="p">);</span>
    <span class="n">onCompletion</span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="n">timestamp</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>We can call this modified <code>updatePerson</code> function by providing the continuation:</p>
<div class="highlight"><pre><span></span><code><span class="kt">long</span> <span class="n">result</span><span class="p">;</span>
<span class="n">updatePerson</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s">&quot;Daniel&quot;</span><span class="p">,</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span> <span class="p">});</span>
</code></pre></div>
<p>Of course, this coroutine is not very lazy yet. It can call other coroutines, so let's assume that the methods on the <code>personRepository</code> are also coroutines. Therefore, we need to provide them with continuations. We will tackle this next.</p>
<h2 id="cps">CPS<a class="headerlink" href="#cps" title="Permanent link">&para;</a></h2>
<p>If <code>personRepository.get()</code> and <code>personRepository.save()</code> are coroutines, we need to provide them with a continuation that they can call. We can do this by splitting our function up into separate <em>function steps</em> like this:</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span> <span class="nf">updatePerson</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">Consumer</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">onCompletion</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Start</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Updating person with ID: &quot;</span> <span class="o">+</span> <span class="n">id</span><span class="p">);</span>
    <span class="n">personRepository</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">,</span>
        <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">updatePerson2</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">onCompletion</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">updatePerson2</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">Consumer</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">onCompletion</span><span class="p">,</span> <span class="n">Person</span> <span class="n">result</span><span class="p">){</span>
    <span class="c1">// Step 2</span>
    <span class="n">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
    <span class="n">person</span><span class="p">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
    <span class="n">personRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">person</span><span class="p">,</span>
        <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">updatePerson3</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">person</span><span class="p">,</span> <span class="n">onCompletion</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">updatePerson3</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">Person</span> <span class="n">person</span><span class="p">,</span> <span class="n">Consumer</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">onCompletion</span><span class="p">,</span> <span class="kt">long</span> <span class="n">result</span><span class="p">){</span>
    <span class="c1">// Step 3</span>
    <span class="kt">long</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Updated at: &quot;</span> <span class="o">+</span> <span class="n">timestamp</span><span class="p">);</span>
    <span class="n">onCompletion</span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="n">timestamp</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Note that the coroutine is called as the last action in each function step. This means that they can take advantage of tail call optimization to avoid creating a new stack frame for each coroutine or continuation call. But tail call optimization has its own downsides: it will appear as if the calls in between never happened, which makes debugging, stack tracing, and access control more difficult. Also note that the above example creates a new closure for every continuation, and finally but most importantly, Java does not support tail call optimization at all.</p>
<h2 id="state-machine">State Machine<a class="headerlink" href="#state-machine" title="Permanent link">&para;</a></h2>
<p>Let's see if we can solve some of these problems. Firstly, let's reduce the number of objects that are needed for representing continuations, because if we were to execute a coroutine in a loop, we would end up with a lot of continuation closure objects.</p>
<p>One way to solve this is to create a state machine, which takes the place of each of the continuations. To call the correct function step, we need to track which step we expect to execute next. Additionally, to provide the arguments and local variables to the call, we store them in the state machine.</p>
<div class="highlight"><pre><span></span><code><span class="kd">class</span> <span class="nc">updatePerson_StateMachine</span> <span class="kd">implements</span> <span class="n">Consumer</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// Arguments</span>
    <span class="n">Test</span> <span class="n">$this</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
    <span class="n">String</span> <span class="n">name</span><span class="p">;</span>

    <span class="c1">// Local variables</span>
    <span class="n">Person</span> <span class="n">person</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">timestamp</span><span class="p">;</span>

    <span class="c1">// State Machine</span>
    <span class="n">updatePerson_State</span> <span class="n">state</span><span class="p">;</span>
    <span class="n">Function</span><span class="o">&lt;</span><span class="n">Object</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">onCompletion</span><span class="p">;</span>

    <span class="n">updatePerson_StateMachine</span><span class="p">(</span><span class="n">Function</span><span class="o">&lt;</span><span class="n">Object</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">onCompletion</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">onCompletion</span> <span class="o">=</span> <span class="n">onCompletion</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accept</span><span class="p">(</span><span class="n">Object</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="n">Start</span><span class="p">:</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="p">();</span>
            <span class="k">case</span> <span class="n">Step2</span><span class="p">:</span> <span class="n">$this</span><span class="p">.</span><span class="na">updatePerson2</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">Step3</span><span class="p">:</span> <span class="n">$this</span><span class="p">.</span><span class="na">updatePerson3</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">person</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">default</span><span class="p">:</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">enum</span> <span class="n">updatePerson_State</span> <span class="p">{</span>
    <span class="n">Start</span><span class="p">,</span>
    <span class="n">Step2</span><span class="p">,</span>
    <span class="n">Step3</span><span class="p">,</span>
    <span class="n">Done</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
<p>The state machine class is relatively straightforward. Being a state machine, it has to store the current state in its <code>state</code> field. The state determines at which function step will resume when the state machine is used as a continuation. Because we reuse the state machine object, it will get return values of different types after each suspending function. Therefore, it has type <code>Consumer&lt;Object&gt;</code>, accepting any object (including <code>null</code>).</p>
<p>It would be used as a continuation like this:</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span> <span class="nf">updatePerson</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">Consumer</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">onCompletion</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Start</span>

    <span class="c1">// Create state machine</span>
    <span class="n">updatePerson_StateMachine</span> <span class="n">cont</span> <span class="o">=</span> <span class="k">new</span> <span class="n">updatePerson_StateMachine</span><span class="p">(</span><span class="n">onCompletion</span><span class="p">);</span>

    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Updating person with ID: &quot;</span> <span class="o">+</span> <span class="n">id</span><span class="p">);</span>

    <span class="c1">// Store arguments</span>
    <span class="n">cont</span><span class="p">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
    <span class="n">cont</span><span class="p">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>

    <span class="c1">// Call coroutine</span>
    <span class="n">cont</span><span class="p">.</span><span class="na">state</span> <span class="o">=</span> <span class="n">updatePerson_State</span><span class="p">.</span><span class="na">Step2</span><span class="p">;</span>
    <span class="n">personRepository</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">cont</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">updatePerson2</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">updatePerson_StateMachine</span> <span class="n">cont</span><span class="p">,</span> <span class="n">Person</span> <span class="n">result</span><span class="p">){</span>
    <span class="c1">// Step 2</span>
    <span class="n">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
    <span class="n">person</span><span class="p">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>

    <span class="c1">// Store local variables</span>
    <span class="n">cont</span><span class="p">.</span><span class="na">person</span> <span class="o">=</span> <span class="n">person</span><span class="p">;</span>    

    <span class="c1">// Call coroutine</span>
    <span class="n">cont</span><span class="p">.</span><span class="na">state</span> <span class="o">=</span> <span class="n">updatePerson_State</span><span class="p">.</span><span class="na">Step3</span><span class="p">;</span>
    <span class="n">personRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">person</span><span class="p">,</span> <span class="n">cont</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">updatePerson3</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">Person</span> <span class="n">person</span><span class="p">,</span> <span class="n">updatePerson_StateMachine</span> <span class="n">cont</span><span class="p">,</span> <span class="kt">long</span> <span class="n">result</span><span class="p">){</span>
    <span class="c1">// Step 3</span>
    <span class="kt">long</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Updated at: &quot;</span> <span class="o">+</span> <span class="n">timestamp</span><span class="p">);</span>
    <span class="n">cont</span><span class="p">.</span><span class="na">onCompletion</span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="n">timestamp</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Here we make the implicit assumption that the state machine continuation is only called zero or one time. If the same continuation would be called more than once, then the stored local variables and next <code>state</code> might go wrong. </p>
<h2 id="single-function">Single Function<a class="headerlink" href="#single-function" title="Permanent link">&para;</a></h2>
<p>Our coroutine is still split across functions, which makes it harder to debug and stack trace. We can improve this by putting the different function steps back into one function, and using the state machine's state to jump to the correct piece of code.</p>
<p>The function needs to determine whether it is being called for the first time (using some other continuation), or being resumed (using the state machine as the continuation). If it is being resumed, it will be given the state machine as its continuation. Otherwise, if this is the first call, it will be given another continuation, and we should instantiate a new state machine and store the arguments and continuation in it.</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span> <span class="nf">updatePerson</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">Consumer</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">onCompletion</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// Get the state machine</span>
    <span class="n">updatePerson_StateMachine</span> <span class="n">cont</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">onCompletion</span> <span class="k">instanceof</span> <span class="n">updatePerson_StateMachine</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Resumed from a previous call</span>
        <span class="n">cont</span> <span class="o">=</span> <span class="p">(</span><span class="n">updatePerson_StateMachine</span><span class="p">)</span><span class="n">onCompletion</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// Called for the first time</span>
        <span class="n">cont</span> <span class="o">=</span> <span class="k">new</span> <span class="n">updatePerson_StateMachine</span><span class="p">(</span><span class="n">onCompletion</span><span class="p">);</span>
        <span class="c1">// Store the arguments</span>
        <span class="n">cont</span><span class="p">.</span><span class="na">$this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="n">cont</span><span class="p">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
        <span class="n">cont</span><span class="p">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>
<details class="bug"><summary>Recursive calls</summary></details>
<p>How do we distinguish a direct recursive call to the coroutine (providing the state machine of the parent call as the continuation) from a resumed call (providing the state machine of this call as the continuation)?</p>
<p>The next step is to decide where to resume to. If we somehow ended up in an illegal state, we throw an exception.</p>
<div class="highlight"><pre><span></span><code>    <span class="n">Person</span> <span class="n">person</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">timestamp</span><span class="p">;</span>

    <span class="n">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">cont</span><span class="p">.</span><span class="na">result</span><span class="p">;</span>

    <span class="c1">// Decide where to resume</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cont</span><span class="p">.</span><span class="na">state</span> <span class="o">==</span> <span class="n">Start</span><span class="p">)</span> <span class="k">goto</span> <span class="n">block0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cont</span><span class="p">.</span><span class="na">state</span> <span class="o">==</span> <span class="n">Step1</span><span class="p">)</span> <span class="k">goto</span> <span class="n">block1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cont</span><span class="p">.</span><span class="na">state</span> <span class="o">==</span> <span class="n">Step2</span><span class="p">)</span> <span class="k">goto</span> <span class="n">block2</span><span class="p">;</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="p">();</span>
</code></pre></div>
<p>Each resumption point has to start with restoring the local variables from the saved state.</p>
<div class="highlight"><pre><span></span><code>    <span class="n">block0</span><span class="p">:</span>
        <span class="c1">// Restore local variables</span>
        <span class="n">person</span> <span class="o">=</span> <span class="n">cont</span><span class="p">.</span><span class="na">person</span><span class="p">;</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">cont</span><span class="p">.</span><span class="na">timestamp</span><span class="p">;</span>
</code></pre></div>
<p>The next code is just the sequential code in between two coroutines. Since we reinstated the arguments and restored local variables, this should be straightforward.</p>
<div class="highlight"><pre><span></span><code>        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Updating person with ID: &quot;</span> <span class="o">+</span> <span class="n">id</span><span class="p">);</span>
</code></pre></div>
<p>Now we end the block with a call to another coroutine. Just before the call we should store the changed local variables (if any), and update the <code>state</code> field to get us to the next step once the continuation is called.</p>
<div class="highlight"><pre><span></span><code>        <span class="c1">// Call coroutine</span>
        <span class="n">cont</span><span class="p">.</span><span class="na">state</span> <span class="o">=</span> <span class="n">updatePerson_State</span><span class="p">.</span><span class="na">Step1</span><span class="p">;</span>
        <span class="n">personRepository</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">cont</span><span class="p">);</span>     <span class="c1">// coroutine</span>
</code></pre></div>
<p>We can exit this function now. Execution will resume from the next block when the continuation is called.</p>
<div class="highlight"><pre><span></span><code>        <span class="c1">// Done.</span>
        <span class="k">return</span><span class="p">;</span>
</code></pre></div>
<p>Upon entering the next step, it should restore the local variables (if any) and handle the result provided to the continuation, the result returned by the coroutine that was called previously. Note that since the result is not provided explicitly as an argument to the function, we store it in the state machine continuation instead.</p>
<div class="highlight"><pre><span></span><code>    <span class="n">block1</span><span class="p">:</span>
        <span class="c1">// Handle the previous result</span>
        <span class="n">person</span> <span class="o">=</span> <span class="p">(</span><span class="n">Person</span><span class="p">)</span><span class="n">result</span><span class="p">;</span>
</code></pre></div>
<p>This is also where we would assign it to a variable. Note that the initial step is not expecting any results yet (because we didn't end up here through calling a coroutine), but later steps do.</p>
<p>The rest of the code is straightforward:</p>
<div class="highlight"><pre><span></span><code>        <span class="n">person</span><span class="p">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>

        <span class="c1">// Store local variables</span>
        <span class="n">cont</span><span class="p">.</span><span class="na">person</span> <span class="o">=</span> <span class="n">person</span><span class="p">;</span>

        <span class="c1">// Call coroutine</span>
        <span class="n">cont</span><span class="p">.</span><span class="na">state</span> <span class="o">=</span> <span class="n">updatePerson_State</span><span class="p">.</span><span class="na">Step2</span><span class="p">;</span>
        <span class="n">personRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">person</span><span class="p">,</span> <span class="n">cont</span><span class="p">);</span>
        <span class="c1">// Done.</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="n">block2</span><span class="p">:</span>
        <span class="c1">// Restore local variables</span>
        <span class="n">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="n">cont</span><span class="p">.</span><span class="na">person</span><span class="p">;</span>

        <span class="c1">// Handle the previous result</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">result</span><span class="p">;</span>

        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Updated at: &quot;</span> <span class="o">+</span> <span class="n">timestamp</span><span class="p">);</span>
</code></pre></div>
<p>However, at the end of the last block, we call the <em>original</em> continuation that we were provided with. Of course, we store the state first.</p>
<div class="highlight"><pre><span></span><code>        <span class="c1">// Store local variables</span>
        <span class="n">cont</span><span class="p">.</span><span class="na">timestamp</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">;</span>

        <span class="c1">// Call continuation</span>
        <span class="n">cont</span><span class="p">.</span><span class="na">onComplete</span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="n">timestamp</span><span class="p">);</span>
        <span class="c1">// Done.</span>
        <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Coroutines returning <code>void</code></p>
</div>
<p>A coroutine that returns no value (<code>void</code>) can be implemented by having it pass <code>null</code> to the continuation (of type <code>Void</code>).</p>
<h2 id="non-suspending-computations">Non-suspending Computations<a class="headerlink" href="#non-suspending-computations" title="Permanent link">&para;</a></h2>
<p>When the coroutine doesn't suspend, it can simply continue its computation. However, if we model this using continuations, for example in a loop, then we might overflow the stack. Instead, it would be better for both stack usage and performance if we could simply skip calling the continuation whenever execution is sequential.</p>
<p>One of three things can happen in a coroutine that calls another coroutine: its continuation gets called immediately, its continuation gets called at some later point, or its continuation gets never called. In all cases does the above implementation simply return.</p>
<p>Since we are sure a continuation is executed either once or never, we can optimize for the case where the coroutine immediately calls the continuation once. We can have the coroutine just return the result and continue normal execution. However, we then also need a way to distinguish this case from the situation where the coroutine <em>doesn't</em> call the continuation, so we can exit early. While we could adopt <code>null</code> to represent this case, <code>null</code> can also be a valid return value. Therefore, in Kotlin, they represent this by returning the special <code>COROUTINE_SUSPENDED</code> constant.</p>
<p>The new code becomes:</p>
<div class="highlight"><pre><span></span><code><span class="n">Object</span> <span class="nf">updatePerson</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">Consumer</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">onCompletion</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// Get the state machine</span>
    <span class="n">updatePerson_StateMachine</span> <span class="n">cont</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">onCompletion</span> <span class="k">instanceof</span> <span class="n">updatePerson_StateMachine</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Resumed from a previous call</span>
        <span class="n">cont</span> <span class="o">=</span> <span class="p">(</span><span class="n">updatePerson_StateMachine</span><span class="p">)</span><span class="n">onCompletion</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// Called for the first time</span>
        <span class="n">cont</span> <span class="o">=</span> <span class="k">new</span> <span class="n">updatePerson_StateMachine</span><span class="p">(</span><span class="n">onCompletion</span><span class="p">);</span>
        <span class="c1">// Store the arguments</span>
        <span class="n">cont</span><span class="p">.</span><span class="na">$this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="n">cont</span><span class="p">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
        <span class="n">cont</span><span class="p">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">Person</span> <span class="n">person</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">timestamp</span><span class="p">;</span>

    <span class="n">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">cont</span><span class="p">.</span><span class="na">result</span><span class="p">;</span>

    <span class="c1">// Decide where to resume</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cont</span><span class="p">.</span><span class="na">state</span> <span class="o">==</span> <span class="n">Start</span><span class="p">)</span> <span class="k">goto</span> <span class="n">block0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cont</span><span class="p">.</span><span class="na">state</span> <span class="o">==</span> <span class="n">Step1</span><span class="p">)</span> <span class="k">goto</span> <span class="n">block1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cont</span><span class="p">.</span><span class="na">state</span> <span class="o">==</span> <span class="n">Step2</span><span class="p">)</span> <span class="k">goto</span> <span class="n">block2</span><span class="p">;</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="p">();</span>

<span class="nl">    block0:</span>
        <span class="c1">// Restore local variables</span>
        <span class="n">person</span> <span class="o">=</span> <span class="n">cont</span><span class="p">.</span><span class="na">person</span><span class="p">;</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">cont</span><span class="p">.</span><span class="na">timestamp</span><span class="p">;</span>

        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Updating person with ID: &quot;</span> <span class="o">+</span> <span class="n">id</span><span class="p">);</span>

        <span class="c1">// Call coroutine</span>
        <span class="n">cont</span><span class="p">.</span><span class="na">state</span> <span class="o">=</span> <span class="n">updatePerson_State</span><span class="p">.</span><span class="na">Step1</span><span class="p">;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">personRepository</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">cont</span><span class="p">);</span>     <span class="c1">// coroutine</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">COROUTINE_SUSPENDED</span><span class="p">)</span> <span class="k">return</span> <span class="n">COROUTINE_SUSPENDED</span><span class="p">;</span>
        <span class="c1">// Fall through</span>
    <span class="n">block1</span><span class="p">:</span>
        <span class="c1">// Handle the previous result</span>
        <span class="n">person</span> <span class="o">=</span> <span class="p">(</span><span class="n">Person</span><span class="p">)</span><span class="n">result</span><span class="p">;</span>

        <span class="n">person</span><span class="p">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>

        <span class="c1">// Store local variables</span>
        <span class="n">cont</span><span class="p">.</span><span class="na">person</span> <span class="o">=</span> <span class="n">person</span><span class="p">;</span>

        <span class="c1">// Call coroutine</span>
        <span class="n">cont</span><span class="p">.</span><span class="na">state</span> <span class="o">=</span> <span class="n">updatePerson_State</span><span class="p">.</span><span class="na">Step2</span><span class="p">;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">personRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">person</span><span class="p">,</span> <span class="n">cont</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">COROUTINE_SUSPENDED</span><span class="p">)</span> <span class="k">return</span> <span class="n">COROUTINE_SUSPENDED</span><span class="p">;</span>
        <span class="c1">// Fall through</span>
    <span class="n">block2</span><span class="p">:</span>
        <span class="c1">// Restore local variables</span>
        <span class="n">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="n">cont</span><span class="p">.</span><span class="na">person</span><span class="p">;</span>

        <span class="c1">// Handle the previous result</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">result</span><span class="p">;</span>

        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Updated at: &quot;</span> <span class="o">+</span> <span class="n">timestamp</span><span class="p">);</span>

        <span class="c1">// Store local variables</span>
        <span class="n">cont</span><span class="p">.</span><span class="na">timestamp</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">;</span>

        <span class="c1">// Done.</span>
        <span class="k">return</span> <span class="n">timestamp</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>Note that the state machine didn't change.</p>
<div class="highlight"><pre><span></span><code><span class="kd">class</span> <span class="nc">updatePerson_StateMachine</span> <span class="kd">implements</span> <span class="n">Consumer</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// Arguments</span>
    <span class="n">Test</span> <span class="n">$this</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
    <span class="n">String</span> <span class="n">name</span><span class="p">;</span>

    <span class="c1">// Local variables</span>
    <span class="n">Person</span> <span class="n">person</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">timestamp</span><span class="p">;</span>

    <span class="c1">// State Machine</span>
    <span class="n">updatePerson_State</span> <span class="n">state</span><span class="p">;</span>
    <span class="n">Consumer</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">onCompletion</span><span class="p">;</span>
    <span class="n">Object</span> <span class="n">result</span><span class="p">;</span>

    <span class="n">updatePerson_StateMachine</span><span class="p">(</span><span class="n">Consumer</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">onCompletion</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">onCompletion</span> <span class="o">=</span> <span class="n">onCompletion</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accept</span><span class="p">(</span><span class="n">Object</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
        <span class="n">$this</span><span class="p">.</span><span class="na">updatePerson</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">enum</span> <span class="n">updatePerson_State</span> <span class="p">{</span>
    <span class="n">Start</span><span class="p">,</span>
    <span class="n">Step2</span><span class="p">,</span>
    <span class="n">Step3</span><span class="p">,</span>
    <span class="n">Done</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="handling-exceptions">Handling Exceptions<a class="headerlink" href="#handling-exceptions" title="Permanent link">&para;</a></h2>
<p>There is also the issue of handling exceptions. Whenever an exception occurs, there are two possibilities: the code was executing sequentially, and the exception can just propagate up the stack; or the exception should be passed to the continuation.</p>
<p>To allow for this, we make the continuation not just accept any value <code>T</code>, but a <code>Result&lt;T&gt;</code>, which is either a value of <code>T</code> or an exception.</p>
<div class="highlight"><pre><span></span><code><span class="kd">class</span> <span class="nc">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">success</span><span class="p">(</span><span class="n">T</span> <span class="n">value</span><span class="p">);</span>
    <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">failure</span><span class="p">(</span><span class="n">Throwable</span> <span class="n">exception</span><span class="p">);</span>

    <span class="kt">boolean</span> <span class="nf">isSuccess</span><span class="p">();</span>
    <span class="kt">boolean</span> <span class="nf">isFailure</span><span class="p">();</span>

    <span class="nd">@Nullable</span> <span class="n">T</span> <span class="nf">getOrNull</span><span class="p">();</span>
    <span class="nd">@Nullable</span> <span class="n">Throwable</span> <span class="nf">exceptionOrNull</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>The signature for the continuation changes from <code>Function&lt;Object, Object&gt;</code> to <code>Function&lt;Result&lt;T&gt;, Object&gt;</code>. To model this even better, we introduce a <code>Continuation</code> interface:</p>
<div class="highlight"><pre><span></span><code><span class="kd">interface</span> <span class="nc">Continuation</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">Consumer</span><span class="o">&lt;</span><span class="n">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
    <span class="kt">void</span> <span class="nf">resumeWith</span><span class="p">(</span><span class="n">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">result</span><span class="p">);</span>

    <span class="nd">@Override</span> <span class="k">default</span> <span class="kt">void</span> <span class="nf">accept</span><span class="p">(</span><span class="n">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span> <span class="n">resumeWith</span><span class="p">(</span><span class="n">result</span><span class="p">);</span> <span class="p">}</span>

    <span class="c1">// Convenience methods:</span>
    <span class="k">default</span> <span class="kt">void</span> <span class="nf">resume</span><span class="p">(</span><span class="n">T</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">resumeWith</span><span class="p">(</span><span class="n">Result</span><span class="p">.</span><span class="na">success</span><span class="p">(</span><span class="n">value</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">default</span> <span class="kt">void</span> <span class="nf">resumeWithException</span><span class="p">(</span><span class="n">Throwable</span> <span class="n">exception</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">resumeWith</span><span class="p">(</span><span class="n">Result</span><span class="p">.</span><span class="na">failure</span><span class="p">(</span><span class="n">exception</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>The basic implementation of <code>Continuation&lt;T&gt;</code> stores another continuation and calls it with the returned result.</p>
<div class="highlight"><pre><span></span><code><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">ContinuationImpl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">Continuation</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Consumer</span><span class="o">&lt;</span><span class="n">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">continuation</span><span class="p">;</span>

    <span class="kd">public</span> <span class="nf">ContinuationImpl</span><span class="p">(</span><span class="n">Consumer</span><span class="o">&lt;</span><span class="n">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">continuation</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">continuation</span> <span class="o">=</span> <span class="n">continuation</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span> <span class="kt">void</span> <span class="nf">resumeWith</span><span class="p">(</span><span class="n">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">newResult</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">T</span> <span class="n">outcome</span> <span class="o">=</span> <span class="n">invokeSuspend</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">outcome</span> <span class="o">==</span> <span class="n">COROUTINE_SUSPENDED</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
            <span class="n">newResult</span> <span class="o">=</span> <span class="n">Result</span><span class="p">.</span><span class="na">success</span><span class="p">(</span><span class="n">outcome</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Throwable</span> <span class="n">exception</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">newResult</span> <span class="o">=</span> <span class="n">Result</span><span class="p">.</span><span class="na">failure</span><span class="p">(</span><span class="n">exception</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">continuation</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="n">continuation</span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="n">newResult</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">abstract</span> <span class="n">Object</span> <span class="nf">invokeSuspend</span><span class="p">(</span><span class="n">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">result</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Optimization</p>
<p>As long as the <code>continuation</code> we call is an instance of <code>ContinuationImpl</code>, we could instead use a loop, where we invoke <code>invokeSuspend</code> on the new continuation and use the previous result as the new continuation argument. Of course, this forces the base class of <code>ContinuationImpl</code> to be <code>Continuation&lt;Any&gt;</code>. </p>
</div>
<p>The implementation of the state machine would be:</p>
<div class="highlight"><pre><span></span><code><span class="kd">class</span> <span class="nc">updatePerson_StateMachine</span> <span class="kd">extends</span> <span class="n">ContinuationImpl</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// Arguments</span>
    <span class="n">Test</span> <span class="n">$this</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
    <span class="n">String</span> <span class="n">name</span><span class="p">;</span>

    <span class="c1">// Local variables</span>
    <span class="n">Person</span> <span class="n">person</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">timestamp</span><span class="p">;</span>

    <span class="c1">// State Machine</span>
    <span class="n">updatePerson_State</span> <span class="n">state</span><span class="p">;</span>
    <span class="n">Consumer</span><span class="o">&lt;</span><span class="n">Result</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;&gt;</span> <span class="n">onCompletion</span><span class="p">;</span>
    <span class="n">Result</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">result</span><span class="p">;</span>

    <span class="n">updatePerson_StateMachine</span><span class="p">(</span><span class="n">Consumer</span><span class="o">&lt;</span><span class="n">Result</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;&gt;</span> <span class="n">onCompletion</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">onCompletion</span> <span class="o">=</span> <span class="n">onCompletion</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">invokeSuspend</span><span class="p">(</span><span class="n">Result</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">$this</span><span class="p">.</span><span class="na">updatePerson</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>And a special <code>Coroutines.throwOnFailure(Result&lt;Any&gt; result)</code> will assert that the result is actually a successful value. Therefore, to handle the result of a coroutine call, it should first check whether the result is actually valid and not an exception.</p>
<h2 id="see-also">See Also<a class="headerlink" href="#see-also" title="Permanent link">&para;</a></h2>
<ul>
<li>KEEP  <a href="https://github.com/Kotlin/KEEP/blob/master/proposals/coroutines.md">Kotlin Coroutines</a></li>
<li>Jorge Castillo  <a href="https://jorgecastillo.dev/digging-into-kotlin-continuations">Kotlin Continuations</a></li>
<li>Ashish Kumar  <a href="https://proandroiddev.com/how-do-coroutines-work-under-the-hood-803e6e9da8bb">Suspend functions under the hood</a></li>
<li>Luciano Almeida  <a href="https://medium.com/@lucianoalmeida1/an-overview-on-kotlin-coroutines-d55e123e137b">An Overview on Kotlin Coroutines</a></li>
<li>Adrian Bukros  <a href="https://www.kotlindevelopment.com/deep-dive-coroutines/">Diving deep into Kotlin Coroutines</a></li>
<li>esoco GmbH  <a href="https://medium.com/@esocogmbh/coroutines-in-pure-java-65661a379c85">Coroutines in pure Java</a></li>
<li><a href="https://stackoverflow.com/a/46103773/146622">COROUTINE_SUSPENDED and suspendCoroutineOrReturn in Kotlin</a></li>
<li><a href="https://labs.pedrofelix.org/guides/kotlin/coroutines/coroutines-and-state-machines">Suspending functions, coroutines and state machines</a></li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.indexes", "navigation.top"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../assets/javascripts/workers/search.fb4a9340.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.a1c7c35e.min.js"></script>
      
    
  </body>
</html>